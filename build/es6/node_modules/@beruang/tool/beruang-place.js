/**
@license
Copyright (c) 2019 The Beruang Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
https://github.com/DatatransInformatika/beruang/blob/master/LICENSE.txt The complete set of authors may be found at
https://github.com/DatatransInformatika/beruang/blob/master/AUTHORS.txt The complete set of contributors may be
found at https://github.com/DatatransInformatika/beruang/blob/master/CONTRIBUTORS.txt
*/if(window.BeruangPlace){window.BeruangPlace._setPopStateListener(!1);window.BeruangPlace._setLeavePageWarn(!1)}window.BeruangPlace=function(){return{setContainer:function(obj){if(obj!=this._singleWidgetContainer){this._singleWidgetContainer=obj;for(var i=0;i<this._places.length;i++){this._closePresenter(this._places[i])}this._places=[];this._currentPlace=null}},go:function(place,data,callback){this._enqueue("go",place,data,callback)},remove:function(place,callback){this._enqueue("remove",place,null,callback)},_enqueue:function(cmd,place,data,callback){if(this._busy){this._queue.unshift({cmd:cmd,place:place,data:data,callback:callback})}else{this._proceed(cmd,place,data,callback)}},_dequeue:function(){if(this._busy){if(this._callback){var cb=this._callback;setTimeout(function(){cb()},100)}this._data=null;this._callback=null;var obj=this._queue.pop();if(obj){setTimeout(function(){this._proceed(obj.cmd,obj.place,obj.data,obj.callback)}.bind(this),500)}else{this._busy=!1}}},_proceed:function(cmd,place,data,callback){this._busy=!0;this._data=data;this._callback=callback;if("go"==cmd){this._go(place,data,callback)}else if("remove"==cmd){this._remove(place,callback)}},_go:function(place,data,callback){if(place!=this._currentPlace){var nextIdx=this._places.indexOf(place);if(-1<nextIdx){var currentIdx=this._places.indexOf(this._currentPlace);window.history.go(nextIdx-currentIdx);//popStateHandler will call this.startPresenter(place, data);
}else{this._startPresenter(place,!0)}}else{this._dequeue()}},_closePresenter:function(place){if(!place.endsWith(this._removedSuffix)){var presenter=this._singleton[place];if(presenter){presenter.close()}}},_remove:function(place,callback){if(place.endsWith(this._removedSuffix)){throw new ReferenceError("place "+place+" is already removed")}var currentIdx=this._places.indexOf(this._currentPlace),removedIdx=this._places.indexOf(place);this._closePresenter(place);var step=removedIdx-currentIdx;this._historyStepThenRun(0!=step,step,function(){var removedPlace=place+this._removedSuffix,obj=window.history.state;obj.place=removedPlace;window.history.replaceState(obj,null,this._placePrefix+removedPlace);this._places[removedIdx]=removedPlace;if(0==step){var nextIdx=this._forwardValidPlace(removedIdx+1);if(0>nextIdx){nextIdx=this._backwardValidPlace(removedIdx-1)}this._currentPlace=removedPlace;if(-1<nextIdx){//setTimeout( function(){
window.history.go(nextIdx-currentIdx);//_dequeue will be called in this._startPresenter
//}.bind(this), 100);
}else{this._dequeue()}}else{//setTimeout( function(){
window.history.go(-1*step);//_dequeue will be called in this._startPresenter
//}.bind(this), 100);
}}.bind(this))},_forwardValidPlace:function(idx){for(var nextIdx=-1,i=idx;i<this._places.length;i++){if(!this._places[i].endsWith(this._removedSuffix)){nextIdx=i;break}}return nextIdx},_backwardValidPlace:function(idx){for(var nextIdx=-1,i=idx;0<=i;i--){if(!this._places[i].endsWith(this._removedSuffix)){nextIdx=i;break}}return nextIdx},_singleWidgetContainer:null,_data:null,_callback:null,_currentPlace:null,_queue:[],_busy:!1,_places:[],_singleton:{},_placePrefix:"#",_removedSuffix:"^",_historyStepThenRun:function(condition,step,callback){if(condition){this._setPopStateListener(!1);window.history.go(step);setTimeout(function(){this._setPopStateListener(!0);callback()}.bind(this),100)}else{callback()}},_startPresenter:function(place,pushState){if(place!=this._currentPlace){var presenter=this._singleton[place];if(presenter){this._startPresenterDo(place,presenter,pushState,this._data)}else{window.BeruangFactory.importMultiModule([place+"-view",place+"-presenter"],function(mv,mp){var v=new mv.default,p=new mp.default(v);this._startPresenterDo(place,p,pushState,this._data)}.bind(this))}}else{this._dequeue()}},_startPresenterDo:function(place,presenter,pushState,data){if(presenter.isSingleTon()){this._singleton[place]=presenter}if(presenter.isHistory()&&pushState){var len=this._places.length,step=0;if(0<len){//assumption: has valid _currentPlace
if(!this._currentPlace){throw new ReferenceError("invalid currentPlace while places array exists")}for(var lastValidIdx=-1,i=len-1;0<=i;i--){if(!this._places[i].endsWith(this._removedSuffix)){lastValidIdx=i;this._places.splice(lastValidIdx+1,this._places.length-lastValidIdx-1);break}}var currentIdx=this._places.indexOf(this._currentPlace);step=lastValidIdx-currentIdx}this._currentPlace=place;this._places.push(place);this._historyStepThenRun(0!=step,step,function(){window.history.pushState({place:place},null,this._placePrefix+place);this._dequeue()}.bind(this))}else{this._currentPlace=place;this._dequeue()}presenter.start(this._singleWidgetContainer,!0,data)},_validHistoryStep:function(place,callback){var asyncCallback=!1,valid=!0,nextIdx=this._places.indexOf(place);if(0>nextIdx){//assumption: only happen when history goes backward
setTimeout(function(){window.history.forward()},100);//so recover with forward
valid=!1}else if(place.endsWith(this._removedSuffix)){var referenceIdx=this._places.indexOf(this._currentPlace),step=nextIdx-referenceIdx,alternativeIdx=-1;if(0>step){//backward
alternativeIdx=this._backwardValidPlace(nextIdx-1)}else if(0<step){//forward
alternativeIdx=this._forwardValidPlace(nextIdx+1)}setTimeout(function(){if(-1<alternativeIdx){window.history.go(alternativeIdx-nextIdx);//go to alternative place
}else{window.history.go(-1*step);//back to _currentPlace
}},100);valid=!1}else{var presenter=this._singleton[this._currentPlace];if(presenter){var currentIdx=this._places.indexOf(this._currentPlace),offset=currentIdx-nextIdx;if(0==offset){valid=!1}else{asyncCallback=!0;presenter.mayLeave(function(may){callback(may);if(!may){setTimeout(function(){window.history.go(offset);//back to _curretPlace
},100)}})}}}if(!asyncCallback){callback(valid)}},_popStateHandler:function(e){var place=e.state?e.state.place:null;//window.location.href.split(this._placePrefix)[1];
this._validHistoryStep(place,function(may){if(may){this._startPresenter(place,!1)}}.bind(this))},_setPopStateListener:function(set){if(this._fPopStateHandler){window.removeEventListener("popstate",this._fPopStateHandler)}if(set){this._fPopStateHandler=this._fPopStateHandler||this._popStateHandler.bind(this);window.addEventListener("popstate",this._fPopStateHandler)}},_setLeavePageWarn:function(set){if(this._fLeavePageWarn){window.removeEventListener("beforeunload",this._fLeavePageWarn)}if(set){this._fLeavePageWarn=function(e){e.returnValue="Are you sure you want to leave?"};window.addEventListener("beforeunload",this._fLeavePageWarn)}}}}();window.BeruangPlace._setPopStateListener(!0);window.BeruangPlace._setLeavePageWarn(!0);